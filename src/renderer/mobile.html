<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <title>åˆ·é¢˜åº”ç”¨ - ç§»åŠ¨ç‰ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .container {
      max-width: 768px;
      margin: 0 auto;
      padding: 1rem;
    }

    .header {
      background: white;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: #333;
    }

    .header p {
      color: #666;
      font-size: 0.9rem;
    }

    .card {
      background: white;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .button {
      display: block;
      width: 100%;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: white;
      background: #3b82f6;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .button:active {
      transform: scale(0.98);
      opacity: 0.8;
    }

    .button-secondary {
      background: #6b7280;
    }

    .button-success {
      background: #10b981;
    }

    .question-card {
      margin-bottom: 1rem;
    }

    .question-text {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      line-height: 1.6;
      color: #333;
    }

    .option {
      padding: 1rem;
      margin-bottom: 0.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .option:active {
      transform: scale(0.98);
    }

    .option.selected {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .option.correct {
      border-color: #10b981;
      background: #d1fae5;
    }

    .option.incorrect {
      border-color: #ef4444;
      background: #fee2e2;
    }

    .result {
      padding: 1rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
    }

    .result.correct {
      background: #d1fae5;
      color: #065f46;
    }

    .result.incorrect {
      background: #fee2e2;
      color: #991b1b;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .stat-item {
      text-align: center;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 0.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #3b82f6;
    }

    .stat-label {
      font-size: 0.875rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }

    .hidden {
      display: none;
    }

    .progress {
      width: 100%;
      height: 0.5rem;
      background: #e5e7eb;
      border-radius: 1rem;
      margin-bottom: 1rem;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: #3b82f6;
      transition: width 0.3s;
    }

    @media (max-width: 480px) {
      .container {
        padding: 0.5rem;
      }

      .card {
        padding: 1rem;
      }

      .button {
        padding: 0.875rem;
      }

      .question-text {
        font-size: 1rem;
      }

      .header h1 {
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¯ åˆ·é¢˜åº”ç”¨</h1>
      <p>éšæ—¶éšåœ°ï¼Œè½»æ¾åˆ·é¢˜</p>
    </div>

    <!-- é¦–é¡µ -->
    <div id="home-page">
      <div class="card">
        <h2 style="margin-bottom: 1rem; color: #333;">é€‰æ‹©æ¨¡å¼</h2>
        <button class="button" onclick="startRandomQuiz()">ğŸ“ éšæœºç»ƒä¹ </button>
        <button class="button button-secondary" onclick="showStats()">ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡</button>
      </div>
    </div>

    <!-- é¢˜ç›®é¡µé¢ -->
    <div id="quiz-page" class="hidden">
      <div class="card">
        <div id="progress-container">
          <div class="progress">
            <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
          </div>
          <p id="progress-text" style="text-align: center; color: #666; margin-bottom: 1rem;">é¢˜ç›® 1 / 10</p>
        </div>

        <div id="question-container"></div>

        <button id="next-button" class="button hidden" onclick="nextQuestion()">ä¸‹ä¸€é¢˜</button>
        <button id="finish-button" class="button button-success hidden" onclick="finishQuiz()">å®Œæˆ</button>
        <button class="button button-secondary" onclick="backToHome()">è¿”å›é¦–é¡µ</button>
      </div>
    </div>

    <!-- ç»Ÿè®¡é¡µé¢ -->
    <div id="stats-page" class="hidden">
      <div class="card">
        <h2 style="margin-bottom: 1rem; color: #333;">ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h2>
        <div class="stats" id="stats-container">
          <div class="stat-item">
            <div class="stat-value" id="total-questions">-</div>
            <div class="stat-label">æ€»é¢˜æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="practiced-count">-</div>
            <div class="stat-label">å·²ç»ƒä¹ </div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="correct-rate">-</div>
            <div class="stat-label">æ­£ç¡®ç‡</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="avg-score">-</div>
            <div class="stat-label">å¹³å‡åˆ†</div>
          </div>
        </div>
        <button class="button" onclick="backToHome()">è¿”å›é¦–é¡µ</button>
      </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loading" class="loading hidden">
      <p>åŠ è½½ä¸­...</p>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let currentQuestions = [];
    let currentIndex = 0;
    let userAnswers = [];
    let score = 0;

    // æ˜¾ç¤º/éšè—é¡µé¢
    function showPage(pageId) {
      document.querySelectorAll('[id$="-page"]').forEach(page => page.classList.add('hidden'));
      document.getElementById(pageId).classList.remove('hidden');
    }

    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

    // è¿”å›é¦–é¡µ
    function backToHome() {
      showPage('home-page');
      currentQuestions = [];
      currentIndex = 0;
      userAnswers = [];
      score = 0;
    }

    // å¼€å§‹éšæœºç»ƒä¹ 
    async function startRandomQuiz() {
      showLoading();
      try {
        const response = await fetch(`${API_BASE}/api/database/questions/random/10`);
        const data = await response.json();
        
        if (data && data.length > 0) {
          currentQuestions = data;
          currentIndex = 0;
          userAnswers = [];
          score = 0;
          showPage('quiz-page');
          displayQuestion();
        } else {
          alert('æ²¡æœ‰æ‰¾åˆ°é¢˜ç›®ï¼Œè¯·å…ˆå¯¼å…¥é¢˜åº“');
        }
      } catch (error) {
        console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
        alert('åŠ è½½é¢˜ç›®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥');
      } finally {
        hideLoading();
      }
    }

    // æ˜¾ç¤ºé¢˜ç›®
    function displayQuestion() {
      const question = currentQuestions[currentIndex];
      const container = document.getElementById('question-container');
      
      // æ›´æ–°è¿›åº¦
      const progress = ((currentIndex + 1) / currentQuestions.length) * 100;
      document.getElementById('progress-bar').style.width = `${progress}%`;
      document.getElementById('progress-text').textContent = `é¢˜ç›® ${currentIndex + 1} / ${currentQuestions.length}`;
      
      // æ˜¾ç¤ºé¢˜ç›®
      let html = `
        <div class="question-card">
          <div class="question-text">${currentIndex + 1}. ${question.question}</div>
          ${question.options.map((opt, i) => `
            <div class="option" onclick="selectOption(${i})" id="option-${i}">
              ${String.fromCharCode(65 + i)}. ${opt}
            </div>
          `).join('')}
        </div>
        <div id="result-container"></div>
      `;
      
      container.innerHTML = html;
      document.getElementById('next-button').classList.add('hidden');
      document.getElementById('finish-button').classList.add('hidden');
    }

    // é€‰æ‹©é€‰é¡¹
    async function selectOption(optionIndex) {
      const question = currentQuestions[currentIndex];
      const correctIndex = question.options.indexOf(question.correctAnswer);
      const isCorrect = optionIndex === correctIndex;
      
      // æ ‡è®°ç­”æ¡ˆ
      document.querySelectorAll('.option').forEach((opt, i) => {
        opt.style.pointerEvents = 'none';
        if (i === correctIndex) {
          opt.classList.add('correct');
        } else if (i === optionIndex && !isCorrect) {
          opt.classList.add('incorrect');
        }
      });
      
      // æ˜¾ç¤ºç»“æœ
      const resultContainer = document.getElementById('result-container');
      resultContainer.innerHTML = `
        <div class="result ${isCorrect ? 'correct' : 'incorrect'}">
          ${isCorrect ? 'âœ… å›ç­”æ­£ç¡®ï¼' : 'âŒ å›ç­”é”™è¯¯'}
          ${question.explanation ? `<p style="margin-top: 0.5rem; font-size: 0.9rem;">${question.explanation}</p>` : ''}
        </div>
      `;
      
      // è®°å½•ç­”æ¡ˆ
      userAnswers.push({
        questionId: question.id,
        correct: isCorrect
      });
      
      if (isCorrect) {
        score++;
      }
      
      // æ›´æ–°ç»Ÿè®¡
      try {
        await fetch(`${API_BASE}/api/database/stats/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            questionId: question.id,
            correct: isCorrect
          })
        });
      } catch (error) {
        console.error('æ›´æ–°ç»Ÿè®¡å¤±è´¥:', error);
      }
      
      // æ˜¾ç¤ºä¸‹ä¸€é¢˜æŒ‰é’®
      if (currentIndex < currentQuestions.length - 1) {
        document.getElementById('next-button').classList.remove('hidden');
      } else {
        document.getElementById('finish-button').classList.remove('hidden');
      }
    }

    // ä¸‹ä¸€é¢˜
    function nextQuestion() {
      currentIndex++;
      displayQuestion();
    }

    // å®Œæˆæµ‹éªŒ
    function finishQuiz() {
      const percentage = Math.round((score / currentQuestions.length) * 100);
      alert(`æµ‹éªŒå®Œæˆï¼\n\næ€»é¢˜æ•°ï¼š${currentQuestions.length}\næ­£ç¡®ï¼š${score}\né”™è¯¯ï¼š${currentQuestions.length - score}\næ­£ç¡®ç‡ï¼š${percentage}%`);
      backToHome();
    }

    // æŸ¥çœ‹ç»Ÿè®¡
    async function showStats() {
      showLoading();
      try {
        const response = await fetch(`${API_BASE}/api/database/stats`);
        const stats = await response.json();
        
        document.getElementById('total-questions').textContent = stats.totalQuestions || 0;
        document.getElementById('practiced-count').textContent = stats.practicedCount || 0;
        document.getElementById('correct-rate').textContent = 
          stats.correctRate !== undefined ? `${Math.round(stats.correctRate)}%` : '-';
        document.getElementById('avg-score').textContent = 
          stats.averageScore !== undefined ? Math.round(stats.averageScore) : '-';
        
        showPage('stats-page');
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
        alert('åŠ è½½ç»Ÿè®¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥');
      } finally {
        hideLoading();
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    window.addEventListener('load', () => {
      console.log('ç§»åŠ¨ç«¯é¡µé¢å·²åŠ è½½');
    });
  </script>
</body>
</html>
